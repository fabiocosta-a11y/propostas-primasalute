let contadorProdutos = 0;
        document.getElementById('dataProposta').valueAsDate = new Date();
        window.onload = function() { adicionarProduto(); };
        
        function adicionarProduto() {
            contadorProdutos++;
            const container = document.getElementById('produtosContainer');
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.id = 'item-' + contadorProdutos;
            
            let optionsHTML = '<option value="">-- Selecione --</option>';
            for (const [codigo, produto] of Object.entries(baseProdutos)) {
                optionsHTML += `<option value="${codigo}">${codigo} - ${produto.nome.substring(0,50)}...</option>`;
            }
            
            itemRow.innerHTML = `
                <input type="text" value="${String(contadorProdutos).padStart(2, '0')}" readonly style="text-align:center; background:#eee;">
                <input type="text" class="codigo-produto" readonly style="background:#f0f0f0; text-align:center;">
                <select class="produto-select" onchange="selecionarProduto(${contadorProdutos}, this.value)">${optionsHTML}</select>
                <input type="number" class="quantidade" value="1" min="1" style="text-align:center;">
                <input type="text" class="valorUnitario" readonly style="background:#e8f5e9; text-align:right;">
                <input type="text" class="valorTotal" readonly style="background:#fff3cd; text-align:right; font-weight:bold;">
                <button class="btn-remove" onclick="removerProduto(${contadorProdutos})">×</button>
            `;
            container.appendChild(itemRow);
        }
        
        function selecionarProduto(id, codigo) {
            if (!codigo) return;
            const produto = baseProdutos[codigo];
            const item = document.getElementById('item-' + id);
            item.querySelector('.codigo-produto').value = codigo;
            item.querySelector('.valorUnitario').value = 'R$ ' + produto.valor.toFixed(2).replace('.', ',');
            item.dataset.codigo = codigo;
            item.dataset.produto = JSON.stringify(produto);
            atualizarValorTotal(id);
        }
        
        function atualizarValorTotal(id) {
            const item = document.getElementById('item-' + id);
            const produto = JSON.parse(item.dataset.produto || '{}');
            const quantidade = parseFloat(item.querySelector('.quantidade').value) || 0;
            const total = produto.valor * quantidade;
            item.querySelector('.valorTotal').value = 'R$ ' + total.toFixed(2).replace('.', ',');
        }
        
        function removerProduto(id) {
            document.getElementById('item-' + id)?.remove();
        }
        
        async function gerarPDF() {
            const nomeCliente = document.getElementById('nomeCliente').value;
            if (!nomeCliente) {
                alert('⚠️ Preencha o nome do cliente!');
                return;
            }
            
            const items = document.querySelectorAll('.item-row');
            const produtos = [];
            items.forEach(item => {
                const select = item.querySelector('.produto-select');
                if (!select.value) return;
                
                const produtoData = JSON.parse(item.dataset.produto);
                const quantidade = parseInt(item.querySelector('.quantidade').value);
                
                produtos.push({
                    codigo: item.dataset.codigo,
                    nome: produtoData.nome,
                    marca: produtoData.marca,
                    valorUnitario: produtoData.valor,
                    quantidade: quantidade,
                    imagem: produtoData.imagem,
                    caracteristicas: produtoData.caracteristicas,
                    incluso: produtoData.incluso,
                    origem: produtoData.origem,
                    registro: produtoData.registro
                });
            });
            
            if (produtos.length === 0) {
                alert('⚠️ Adicione pelo menos um produto!');
                return;
            }
            
            const dados = {
                numeroProposta: document.getElementById('numeroProposta').value,
                dataProposta: document.getElementById('dataProposta').value,
                comercial: document.getElementById('comercial').value,
                telefoneVenda: document.getElementById('telefoneVenda').value,
                nomeCliente: nomeCliente,
                cnpjCliente: document.getElementById('cnpjCliente').value,
                ieCliente: document.getElementById('ieCliente').value,
                contatoCliente: document.getElementById('contatoCliente').value,
                cargoCliente: document.getElementById('cargoCliente').value,
                emailCliente: document.getElementById('emailCliente').value,
                telefoneCliente: document.getElementById('telefoneCliente').value,
                ruaFaturamento: document.getElementById('ruaFaturamento').value,
                bairroFaturamento: document.getElementById('bairroFaturamento').value,
                cidadeFaturamento: document.getElementById('cidadeFaturamento').value,
                estadoFaturamento: document.getElementById('estadoFaturamento').value,
                cepFaturamento: document.getElementById('cepFaturamento').value,
                ruaEntrega: document.getElementById('ruaEntrega').value,
                bairroEntrega: document.getElementById('bairroEntrega').value,
                cidadeEntrega: document.getElementById('cidadeEntrega').value,
                estadoEntrega: document.getElementById('estadoEntrega').value,
                cepEntrega: document.getElementById('cepEntrega').value,
                frete: document.getElementById('frete').value,
                entrega: document.getElementById('entrega').value,
                prazoPagamento: document.getElementById('prazoPagamento').value,
                pagamento: document.getElementById('pagamento').value,
                validade: document.getElementById('validade').value,
                transportadora: document.getElementById('transportadora').value,
                produtos: produtos
            };
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('btnGerar').disabled = true;
            
            try {
                const response = await fetch('/api/gerar-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                if (!response.ok) throw new Error('Erro ao gerar PDF');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Proposta_${dados.numeroProposta.replace('/', '-')}_${dados.nomeCliente}.pdf`;
                a.click();
                
                alert('✅ PDF gerado com QUALIDADE PERFEITA!');
            } catch (error) {
                alert('❌ Erro: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('btnGerar').disabled = false;
            }
        }
    </script>
</body>
</html>
